GetConnectionEnemies = function(a)
	for i, v in pairs(replicated:GetChildren()) do
		if v:IsA("Model") and  ((typeof(a) == "table" and table.find(a, v.Name)) or v.Name == a) and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
			return v
		end
	end
	for i, v in next, game.Workspace.Enemies:GetChildren() do
		if v:IsA("Model") and ((typeof(a) == "table" and table.find(a, v.Name)) or v.Name == a)  and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
			return v
		end
	end
end

Distance = function(a, b, noHeight)
	local vector_a = Vector3.new(a.X, noHeight and 0 or a.Y, a.Z)

	local success, result = pcall(function()
		if not b then
			repeat
				local Root = localplayer.Character and localplayer.Character:FindFirstChild("HumanoidRootPart")
				b = Root and Root.Position
				task.wait(0.5)
			until b
		end

		local vector_b = Vector3.new(b.X, noHeight and 0 or b.Y, b.Z)
		return (vector_a - vector_b).Magnitude
	end)

	if success then
		return result
	end
	return nil
end

-- BringMob = function(Mon)
-- 	Has_Near_Mob = false
-- 	for _, enemy in pairs(workspace.Enemies:GetChildren()) do
-- 		local humanoidRootPart = enemy:FindFirstChild("HumanoidRootPart")
-- 		local humanoid = enemy:FindFirstChildOfClass("Humanoid")

-- 		if GetConnectionEnemies(es, enemy) and Distance(humanoidRootPart.Position, Mon.HumanoidRootPart.Position) <= 1e9 then
-- 			local isValidMob = not Mon or (enemy ~= Mon and enemy.Name == Mon.Name)

-- 			if isValidMob then
-- 				if not enemy:FindFirstChild("HumanoidRootPart"):FindFirstChild("BodyVelocity") then
-- 					local G = Instance.new("BodyVelocity")
-- 					G.Parent = enemy:FindFirstChild("HumanoidRootPart")
-- 					G.Name = "BodyVelocity"
-- 					G.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
-- 					G.Velocity = Vector3.new(0, 0, 0)
-- 				end

-- 				if enemy:FindFirstChild("HumanoidRootPart"):FindFirstChild("BodyVelocity") then
-- 					enemy:FindFirstChild("HumanoidRootPart").BodyVelocity.Velocity = Vector3.new(0, 0, 0)
-- 					enemy:FindFirstChild("HumanoidRootPart").BodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
-- 				end

-- 				for _, v in pairs(Mon:GetDescendants()) do
-- 					if v:IsA("BasePart") then
-- 						v.CanCollide = false
-- 					end
-- 				end

-- 				local monPos = Mon.HumanoidRootPart.CFrame.Position
-- 				local distanceToMon = Distance(humanoidRootPart.Position, monPos)

-- 				if distanceToMon <= 10 then
-- 					Has_Near_Mob = true
-- 				end
-- 				if not Has_Near_Mob and (isnetworkowner(humanoidRootPart) or Distance(humanoidRootPart.Position, Mon.HumanoidRootPart.CFrame.Position) < 300) then
-- 					humanoidRootPart.CFrame = CFrame.new(Mon.HumanoidRootPart.CFrame.Position) * CFrame.Angles(0, math.rad(0), 0)
-- 				end
-- 			end
-- 		end
-- 	end

-- end

local plr = game.Players.LocalPlayer

TweenObject = function(Object, Pos, Speed)
	if Speed == nil then
		Speed = 350
	end
	local Distance = (Pos.Position - Object.Position).Magnitude
	local tweenService = game:GetService("TweenService")
	local info = TweenInfo.new(Distance / Speed, Enum.EasingStyle.Linear)
	tween1 = tweenService:Create(Object, info, {
		CFrame = Pos
	})
	tween1:Play()
end

GetMobPosition = function(EnemiesName)
	local pos
	local count = 0
	for r, v in pairs(workspace.Enemies:GetChildren()) do
		if v.Name == EnemiesName then
			if not pos then
				pos = v.HumanoidRootPart.Position
			else
				pos = pos + v.HumanoidRootPart.Position
			end
			count = count + 1
		end
	end
	pos = pos / count
	return pos
end

BringMob = function(value)
	if value then
		local ememe = game.Workspace.Enemies:GetChildren()
		if #ememe > 0 then
			local totalpos = {}
			for _, v in pairs(ememe) do
				if not totalpos[v.Name] then
					totalpos[v.Name] = GetMobPosition(v.Name)
				end
			end
			for _, v in pairs(workspace.Enemies:GetChildren()) do
				if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v:FindFirstChild("HumanoidRootPart") then
					if (v.HumanoidRootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude <= 1e9 then
						for k, f in pairs(totalpos) do
							if k and v.Name == k and f then
								Gay = CFrame.new(f.X, f.Y, f.Z)
								Cac = (v.HumanoidRootPart.Position - Gay.Position).Magnitude
								if Cac > 10 and Cac <= 500 then
									TweenObject(v.HumanoidRootPart, Gay, 300)
									v.HumanoidRootPart.CanCollide = false
									v.Humanoid.WalkSpeed = 0
									v.Humanoid.JumpPower = 0
									v.Humanoid:ChangeState(14)
									sethiddenproperty(plr, "SimulationRadius", math.huge)
								end
							end
						end
					end
				end
			end
		end
	end
end
BringMob(true)

BringEnemies = function(mmb)
	while task.wait() do
		local player = game.Players.LocalPlayer
		local character = player.Character
		if not character or not character:FindFirstChild("HumanoidRootPart") then
			continue
		end
		local hrpPlayer = character.HumanoidRootPart
		local enemiesFolder = workspace:FindFirstChild("Enemies")
		if not enemiesFolder then
			continue
		end

		local enemies = {}
		for _, mob in ipairs(enemiesFolder:GetChildren()) do
			if mob:FindFirstChild("Humanoid") and mob:FindFirstChild("HumanoidRootPart") then
				if mob.Humanoid.Health > 0 then
					table.insert(enemies, mob)
				end
			end
		end

		local count = #enemies
		local radius = 10

		for i, mob in ipairs(enemies) do
			local hrp = mob:FindFirstChild("HumanoidRootPart")
			if not hrp then
				continue
			end

			local angle = (2 * math.pi / math.max(count, 1)) * (i - 1)
			local offset = Vector3.new(math.cos(angle), 0, math.sin(angle)) * radius
			local targetPos = Vector3.new(
				hrpPlayer.Position.X + offset.X,
				hrpPlayer.Position.Y - 3.5, 
				hrpPlayer.Position.Z + offset.Z
			)
		
			local bp = hrp:FindFirstChild("BodyPosition")
			if not bp then
				bp = Instance.new("BodyPosition")
				bp.Name = "BodyPosition"
				bp.MaxForce = Vector3.new(1e6, 1e6, 1e6)
				bp.D = 1000
				bp.P = 5000
				bp.Parent = hrp
			end
			bp.Position = targetPos

			local bv = hrp:FindFirstChild("BodyVelocity")
			if bv then
				bv:Destroy()
			end

			task.spawn(function()
				for _, part in pairs(mob:GetDescendants()) do
					if part:IsA("BasePart") then
						part.CanCollide = false
					end
				end
			end)

			local hum = mob:FindFirstChildOfClass("Humanoid")
			if hum then
				hum.WalkSpeed = 0
				hum.JumpPower = 0
				pcall(function()
					hum:ChangeState(14)
				end)
			end

			pcall(function()
                (function()local p=game:GetService("Players").LocalPlayer;(function()sethiddenproperty(p,"SimulationRadius",math.huge)end)();return function(h)return(isnetworkowner and isnetworkowner(h))or not isnetworkowner end end)()
			end)
		end
	end
end
BringEnemies(mmb, v, true)
--bu cac
local bringMob = newcclosure(function(v,s)
    local xpcallHandler = function() end
    xpcall(function()
        if typeof(setscriptable) == "function" then setscriptable(game:GetService("Players").LocalPlayer, "SimulationRadius", true) end
        if typeof(sethiddenproperty) == "function" then sethiddenproperty(game:GetService("Players").LocalPlayer, "SimulationRadius", math.huge) end
        local localPlayer = game:GetService("Players").LocalPlayer
        local character = localPlayer.Character
        local p = character and character:FindFirstChild("HumanoidRootPart")
        if not p then return end
        local targets = {}
        local workspaceEnemies = workspace:FindFirstChild("Enemies")
        if workspaceEnemies then
            for _, x in next, workspaceEnemies:GetChildren() do
                if #targets >= 5 then break end
                local hrp = x:FindFirstChild("HumanoidRootPart")
                local hum = x:FindFirstChild("Humanoid")
                if hrp and hum and hum.Health > 0 then
                    local nameCheck = not v or x.Name == v
                    local distanceCheck = (p.Position - hrp.Position).Magnitude <= 1e9
                    if nameCheck and distanceCheck then
                        targets[#targets + 1] = x
                    end
                end
            end
        end
        if #targets == 0 then return end
        local t = targets[1].HumanoidRootPart.CFrame
        for _, x in next, targets do
            local targetHrp = x:FindFirstChild("HumanoidRootPart")
            if targetHrp then
                targetHrp.CFrame = t
            end
        end
        for _, npc in next, workspaceEnemies:GetChildren() do
            local hrp = npc:FindFirstChild("HumanoidRootPart")
            local hum = npc:FindFirstChild("Humanoid")
            if hrp and hum and hum.Health == hum.MaxHealth and p then
                local distance = (p.Position - hrp.Position).Magnitude
                if distance <= 30 then
                    task.spawn(function()
                        local oldPos = hrp.Position
                        task.wait(3)
                        local newPos = hrp.Position
                        if (oldPos - newPos).Magnitude < 0.5 and npc:FindFirstChild('Humanoid') and npc.Humanoid.Health == npc.Humanoid.MaxHealth then
                            if npc and npc.Parent then
                                npc:Destroy()
                            end
                        end
                    end)
                end
            end
        end
    end, xpcallHandler)
end)
bringMob(nil,true)

local BringDistance = 500
local TrackedMobs = {}
local AntiGhostCooldown = {}
local MaxMobsToBring = 2
local GhostCheckTime = 5
local MobDamageTracker = {}

function GetPosMonVector3()
	if not PosMon then
		return nil
	end
	if typeof(PosMon) == "CFrame" then
		return PosMon.Position
	elseif typeof(PosMon) == "Vector3" then
		return PosMon
	elseif typeof(PosMon) == "Instance" and PosMon:IsA("BasePart") then
		return PosMon.Position
	end
end

function IsValidMob(mob)
	if not mob or not mob.Parent then
		return false
	end
	if not mob:FindFirstChild("Humanoid") or not mob:FindFirstChild("HumanoidRootPart") then
		return false
	end
	if mob.Humanoid.Health <= 0 then
		return false
	end
	if mob.Name ~= NameMon then
		return false
	end
	if mob.Name == "Ice Admiral" or mob.Name == "Don Swan" or mob.Name == "Saber Expert" or mob.Name == "Longma" then
		return false
	end
	local pos = GetPosMonVector3()
	if not pos then
		return false
	end
	if (mob.HumanoidRootPart.Position - pos).Magnitude > BringDistance then
		return false
	end
	if table.find(TrackedMobs, mob) then
		return false
	end
	return true
end

function LockMob(mob)
	if not mob or not mob.Parent then
		return false
	end
	local root = mob:FindFirstChild("HumanoidRootPart")
	local hum = mob:FindFirstChild("Humanoid")
	if not root or not hum then
		return false
	end
	local pos = GetPosMonVector3()
	if not pos then
		return
	end
	local isOwner = true
	if syn and isnetworkowner then
		local ok, res = pcall(function()
			return isnetworkowner(root)
		end)
		if ok and type(res) == "boolean" then
			isOwner = res
		end
	end
	if isOwner then
		local now = tick()
		if not AntiGhostCooldown[mob] or now - AntiGhostCooldown[mob] > 1 then
			AntiGhostCooldown[mob] = now
			for _, obj in pairs(root:GetChildren()) do
				if obj:IsA("BodyMover") then
					obj:Destroy()
				end
			end
		end
		root.CFrame = CFrame.new(pos)
		pcall(function()
			if not hum:GetAttribute("OriginalWalkSpeed") then
				hum:SetAttribute("OriginalWalkSpeed", hum.WalkSpeed)
			end
			if not hum:GetAttribute("OriginalJumpPower") then
				hum:SetAttribute("OriginalJumpPower", hum.JumpPower)
			end
			hum.WalkSpeed = 0
			hum.JumpPower = 0
			hum.Sit = false
			hum:ChangeState(14)
			if mob:FindFirstChild("Head") then
				mob.Head.CanCollide = false
			end
			root.CanCollide = false
			sethiddenproperty(game.Players.LocalPlayer, "SimulationRadius", math.huge)
		end)
		if not root:FindFirstChild("HoldPos") then
			local bp = Instance.new("BodyPosition")
			bp.Name = "HoldPos"
			bp.MaxForce = Vector3.new(1e9, 1e9, 1e9)
			bp.D = 4000
			bp.P = 60000
			bp.Position = pos
			bp.Parent = root
		else
			root.HoldPos.Position = pos
		end
		if not root:FindFirstChild("HoldGyro") then
			local bg = Instance.new("BodyGyro")
			bg.Name = "HoldGyro"
			bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
			bg.P = 50000
			bg.CFrame = CFrame.new(pos)
			bg.Parent = root
		else
			root.HoldGyro.CFrame = CFrame.new(pos)
		end
		if not MobDamageTracker[mob] then
			MobDamageTracker[mob] = {
				health = hum.Health,
				time = tick()
			}
		end
	end
	return isOwner
end

function CheckGhostMob(mob)
	if not mob or not mob.Parent then
		return true
	end
	local data = MobDamageTracker[mob]
	if not data then
		return false
	end
	local hum = mob:FindFirstChild("Humanoid")
	if not hum then
		return true
	end
	local currentTime = tick()
	if currentTime - data.time >= GhostCheckTime then
		if math.abs(hum.Health - data.health) < 1 then
			return true
		else
			MobDamageTracker[mob] = {
				health = hum.Health,
				time = currentTime
			}
		end
	end
	return false
end

function ReleaseMob(mob)
	if mob and mob.Parent then
		local root = mob:FindFirstChild("HumanoidRootPart")
		if root then
			for _, v in pairs(root:GetChildren()) do
				if v:IsA("BodyMover") then
					v:Destroy()
				end
			end
			root.CanCollide = true
		end
		if mob:FindFirstChild("Head") then
			mob.Head.CanCollide = true
		end
		local hum = mob:FindFirstChild("Humanoid")
		if hum then
			pcall(function()
				hum.WalkSpeed = hum:GetAttribute("OriginalWalkSpeed") or 16
				hum.JumpPower = hum:GetAttribute("OriginalJumpPower") or 50
				hum:SetAttribute("OriginalWalkSpeed", nil)
				hum:SetAttribute("OriginalJumpPower", nil)
				hum:ChangeState(1)
			end)
		end
	end
	MobDamageTracker[mob] = nil
	AntiGhostCooldown[mob] = nil
end

function PullMobs()
	if not Studio["Kaitun"]["Start Farm"] or not PosMon or not NameMon then
		return
	end
	local pos = GetPosMonVector3()
	if not pos then
		return
	end
	for i = #TrackedMobs, 1, -1 do
		local mob = TrackedMobs[i]
		if not mob or not mob.Parent or not mob:FindFirstChild("Humanoid") or mob.Humanoid.Health <= 0 or mob.Name ~= NameMon then
			ReleaseMob(mob)
			table.remove(TrackedMobs, i)
		else
			if CheckGhostMob(mob) then
				ReleaseMob(mob)
				table.remove(TrackedMobs, i)
			else
				LockMob(mob)
			end
		end
	end
	if #TrackedMobs < MaxMobsToBring then
		for _, mob in pairs(workspace.Enemies:GetChildren()) do
			if #TrackedMobs >= MaxMobsToBring then
				break
			end
			if IsValidMob(mob) and LockMob(mob) then
				table.insert(TrackedMobs, mob)
			end
		end
	end
end
task.spawn(function()
	while task.wait(0.05) do
		pcall(PullMobs)
	end
end)
