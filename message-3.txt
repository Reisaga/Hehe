local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")

local Safety = {}
Safety.__index = Safety

local function silentError(_) end

local function safecall(fn, ...)
	return xpcall(fn, silentError, ...)
end

function Safety:IsServerExpected()
	if RunService:IsServer() then
		local hasPlayer = Players:FindFirstChildOfClass("Player")
		if not hasPlayer then
			return false
		end
		return true
	elseif RunService:IsClient() then
		local lp = Players.LocalPlayer
		if not lp then
			return false
		end
		return true
	end
	return false
end

function Safety:EnvironmentCheck()
	if not (TeleportService and Players and RunService) then
		return false
	end
	if type(game.PlaceId) ~= "number" or game.PlaceId <= 0 then
		return false
	end
	if not self:IsServerExpected() then
		return false
	end
	return true
end

function Safety:CheckIntegrity(fn)
	if type(fn) ~= "function" then
		return false
	end
	local info = debug.info and safecall(debug.info, fn, "s")
	if info then
		if string.find(info, "ReplicatedStorage") or string.find(info, "StarterPlayer") then
			return true
		end
	end
	return true
end

function Safety:GlobalCheck()
	local forbidden = { "hookfunction", "getrawmetatable", "setmetatable" }
	local env = getfenv()
	for _, name in ipairs(forbidden) do
		if rawget(env, name) ~= nil then
			return false
		end
	end
	if rawget(env, "debug") and type(env.debug) == "table" then
		if rawget(env.debug, "getupvalue") or rawget(env.debug, "sethook") then
			return false
		end
	end
	return true
end

function Safety:Validate()
	local okEnv = self:EnvironmentCheck()
	local okGlob = self:GlobalCheck()
	return okEnv and okGlob
end

setmetatable(Safety, {
	__call = function(cls, ...)
		return cls:Validate(...)
	end,
	__metatable = false
})

return Safety
