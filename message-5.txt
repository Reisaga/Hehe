local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local CameraShakerR = require(ReplicatedStorage.Util.CameraShaker)
local ShootGunEvent = ReplicatedStorage.Modules.Net["RE/ShootGunEvent"]

local FastAttack = {
	Distance = 50,
	attackMobs = true,
	attackPlayers = true,
	Equipped = nil,
	Debounce = 0,
	ComboDebounce = 0,
	ShootDebounce = 0,
	M1Combo = 0,
	Overheat = {["Dragonstorm"] = {MaxOverheat = 3,Cooldown = 0,TotalOverheat = 0,Distance = 350,Shooting = false}},
	ShootsPerTarget = {["Dual Flintlock"] = 2},
	SpecialShoots = {["Skull Guitar"] = "TAP",["Bazooka"] = "Position",["Cannon"] = "Position",["Dragonstorm"] = "Overheat"},
	HitboxLimbs = {"RightLowerArm","RightUpperArm","LeftLowerArm","LeftUpperArm","RightHand","LeftHand"}
}

local cl = {"PirateBasic","PirateBrigade","FishBoat"}
local Characters = Workspace:WaitForChild("Characters")
local Enemies = Workspace:WaitForChild("Enemies")
local SeaBeasts = Workspace:WaitForChild("SeaBeasts")
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RE_ShootGunEvent = Net:WaitForChild("RE/ShootGunEvent")

local function IsAlive(c)
	return c and c:FindFirstChild("Humanoid") and c.Humanoid.Health > 0 and c:FindFirstChild("HumanoidRootPart") and not c:FindFirstChild("VehicleSeat")
end

function FastAttack:GetAllBladeHits(character, distance)
    local pos = character:GetPivot().Position
    local hits = {}
    distance = distance or self.Distance

    local function process(folder, enabled)
        if not enabled then return end
        for _, enemy in ipairs(folder:GetChildren()) do
            local part = enemy.PrimaryPart
            if part and (pos - part.Position).Magnitude <= distance then
                table.insert(hits, {enemy, part})
            end
        end
    end

    process(workspace.Enemies, self.attackMobs)
    process(workspace.Characters, self.attackPlayers)
    return hits
end

function FastAttack:GetClosestEnemy(character, distance)
    local hits = self:GetAllBladeHits(character, distance)
    local best, bestDist
    for _, h in ipairs(hits) do
        local d = (character:GetPivot().Position - h[2].Position).Magnitude
        if not bestDist or d < bestDist then
            best, bestDist = h[2], d
        end
    end
    return best
end

function FastAttack:GetGunHits(character, distance)
    local hits = self:GetAllBladeHits(character, distance)
    local group = {}
    for _, h in ipairs(hits) do
        if not group[1] or (h[2].Position - group[1].Position).Magnitude <= 10 then
            table.insert(group, h[2])
        end
    end
    return group
end

function FastAttack:GetCombo()
    local combo = (tick() - self.ComboDebounce <= 0.4) and self.M1Combo or 0
    combo = (combo >= 4) and 1 or (combo + 1)
    self.ComboDebounce = tick()
    self.M1Combo = combo
    return combo
end

function FastAttack:UseGunShoot(Character, Equipped)
    if not (Equipped and Equipped.Enabled) then return end

    local shootType = self.SpecialShoots[Equipped.Name] or "Normal"

    local function incrementShots()
        Equipped:SetAttribute("LocalTotalShots", (Equipped:GetAttribute("LocalTotalShots") or 0) + 1)
        GunValidator:FireServer(self:GetValidator2())
    end

    if shootType == "Overheat" then
        local data = self.Overheat[Equipped.Name]
        if not data or data.Shooting then return end

        local target = self:GetClosestEnemy(Character, data.Distance or 100)
        if not target then return end

        data.Shooting = true
        while Equipped and Equipped.Parent == Player.Character and data.TotalOverheat < data.MaxOverheat do
            if target and target.Parent and IsAlive(target.Parent) then
                incrementShots()
                RE_ShootGunEvent:FireServer(target.Position, { target })
                data.TotalOverheat += task.wait(data.Cooldown)
            else
                break
            end
        end
        while data.TotalOverheat > 0 do
            data.TotalOverheat = math.clamp(data.TotalOverheat - task.wait(), 0, data.MaxOverheat)
        end
        data.Shooting = false

    elseif shootType == "Normal" then
        local hits = self:GetGunHits(Character, 120)
        local targetPos = hits[1] and hits[1].Position
        if not targetPos then return end

        incrementShots()
        for i = 1, (self.ShootsPerTarget[Equipped.Name] or 1) do
            RE_ShootGunEvent:FireServer(targetPos, hits)
        end

    elseif shootType == "Position" or (shootType == "TAP" and Equipped:FindFirstChild("RemoteEvent")) then
        local target = self:GetClosestEnemy(Character, 200)
        if not target then return end

        if self.ShootsFunctions[Equipped.Name] then
            return self.ShootsFunctions[Equipped.Name](self, Equipped, target.Position)
        end

        incrementShots()
        if shootType == "TAP" then
            Equipped.RemoteEvent:FireServer("TAP", target.Position)
        else
            RE_ShootGunEvent:FireServer(target.Position)
        end
    end
end

function FastAttack:GetValidator2()
    local v1 = getupvalue(self.ShootFunction, 15)
    local v2 = getupvalue(self.ShootFunction, 13)
    local v3 = getupvalue(self.ShootFunction, 16)
    local v4 = getupvalue(self.ShootFunction, 17)
    local v5 = getupvalue(self.ShootFunction, 14)
    local v6 = getupvalue(self.ShootFunction, 12)
    local v7 = getupvalue(self.ShootFunction, 18)
        
    local v8 = v6 * v2
    local v9 = (v5 * v2 + v6 * v1) % v3
    v9 = (v9 * v3 + v8) % v4
    v5 = math.floor(v9 / v3)
    v6 = v9 - v5 * v3
    v7 = v7 + 1    
    setupvalue(self.ShootFunction, 15, v1)
    setupvalue(self.ShootFunction, 13, v2)
    setupvalue(self.ShootFunction, 16, v3)
    setupvalue(self.ShootFunction, 17, v4)
    setupvalue(self.ShootFunction, 14, v5)
    setupvalue(self.ShootFunction, 12, v6)
    setupvalue(self.ShootFunction, 18, v7)
        
    return math.floor(v9 / v4 * 16777215), v7
end	

local function getHead()
	local r = {}
	for _,v in next, Enemies:GetChildren() do
		if table.find(cl,v.Name) and v:FindFirstChild("Body") then
			for _,v1 in next,v.Body:GetChildren() do
				if (v1.Position-LocalPlayer.Character.HumanoidRootPart.Position).Magnitude<500 then
					r[#r+1]=v1
					return r
				end
			end
		elseif v:FindFirstChild("Humanoid") and v.Humanoid.Health>0 then
			if (v.Head.Position-LocalPlayer.Character.HumanoidRootPart.Position).Magnitude<100 then
				r[#r+1]=v.HumanoidRootPart
			end
		end
	end
	if #r==0 then
		for _,v in next, SeaBeasts:GetChildren() do
			if v:FindFirstChild("RootPart") then
				if (v.RootPart.Position-LocalPlayer.Character.HumanoidRootPart.Position).Magnitude<500 then
					r[#r+1]=v.RootPart
				end
			end
		end
	end
	return r
end

local function FastShooted()
	local h=getHead()
	for i=1,#h do
		if #h>0 then
			local self=FastAttack
			local Character=LocalPlayer.Character
			if not IsAlive(Character) then return end
			local Humanoid=Character.Humanoid
			local Equipped=Character:FindFirstChildOfClass("Tool")
			local ToolTip=Equipped and Equipped.ToolTip
			if Equipped and (ToolTip=="Gun" or ToolTip=="Melee" or ToolTip=="Blox Fruit" or ToolTip=="Sword") then
				local Cooldown=Equipped:FindFirstChild("Cooldown") and Equipped.Cooldown.Value or 0.3
				if (tick()-self.Debounce)>=Cooldown and self:CheckStun(ToolTip,Character,Humanoid) then
					local Combo=self:GetCombo()
					Cooldown+=Combo>=4 and 0.05 or 0
					self.Equipped=Equipped
					self.Debounce=Combo>=4 and ToolTip~="Gun" and (tick()+0.05) or tick()
					if ToolTip=="Gun" then
						self:UseGunShoot(Character,Equipped)
						ShootGunEvent:FireServer(h[i].Position,{[1]=h[i]})
						ShootGunEvent:FireServer(h[i].Position,{[1]=h[i]})
						sethiddenproperty(LocalPlayer,"SimulationRadius",math.huge)
					end
				end
			end
		end
	end
end

for i=1,20 do
	task.spawn(function()
		while task.wait() do
			local ok,err=xpcall(FastShooted,function()end)
			if not ok then break end
			CameraShakerR:Stop()
			if not FastShot then break end
		end
	end)
end

local P = game:GetService("Players")
local L = P.LocalPlayer
local RS = game:GetService("ReplicatedStorage")
local W = workspace
local M = RS:WaitForChild("Modules")

local CU = pcall(require, M:WaitForChild("CombatUtil")) and require(M.CombatUtil) or nil
local WD = pcall(require, M:WaitForChild("WeaponData")) and require(M.WeaponData) or nil
if not CU then
	return
end

local N = M:FindFirstChild("Net")
local RA = N and (N:FindFirstChild("RE/RegisterAttack") or N:FindFirstChild("RegisterAttack"))
local RH = N and (N:FindFirstChild("RE/RegisterHit") or N:FindFirstChild("RegisterHit"))

local IS
do
	local PS = L:WaitForChild("PlayerScripts")
	for _, s in next, PS:GetChildren() do
		if s:IsA("LocalScript") then
			local ok, env = pcall(getsenv, s)
			if ok and env and env._G and typeof(env._G.SendHitsToServer) == "function" then
				IS = env._G.SendHitsToServer
				break
			end
		end
	end
	if not IS and _G.SendHitsToServer then
		IS = _G.SendHitsToServer
	end
end

pcall(function()
	hookfunction(CU.GetComboPaddingTime, function()
		return 0
	end)
	hookfunction(CU.GetAttackCancelMultiplier, function()
		return 0
	end)
	hookfunction(CU.CanAttack, function()
		return true
	end)
end)

local HList = {
	"RightLowerArm",
	"RightUpperArm",
	"LeftLowerArm",
	"LeftUpperArm",
	"RightHand",
	"LeftHand",
	"HumanoidRootPart",
	"Head",
	"UpperTorso",
	"LowerTorso"
}

okm = function(m)
	local h = m:FindFirstChildWhichIsA("Humanoid")
	return h and h.Health > 0 and m:FindFirstChild("HumanoidRootPart") and not m:FindFirstChild("VehicleSeat")
end

hpt = function(m)
	for _ = 1, 2 do
		local p = m:FindFirstChild(HList[math.random(1, #HList)])
		if p then
			return p
		end
	end
	return m:FindFirstChild("HumanoidRootPart")
end

near = function(r, maxN)
	local out, ch = {}, L.Character
	if not ch then
		return out
	end

	local hrp = ch:FindFirstChild("HumanoidRootPart")
	if not hrp then
		return out
	end
	local p0 = hrp.Position

	for _, grp in next, {
		W:FindFirstChild("Enemies"),
		W:FindFirstChild("Characters")
	} do
		if grp then
			for _, v in next, grp:GetChildren() do
				if #out >= maxN then
					break
				end
				if v ~= ch and okm(v) then
					local hr = v:FindFirstChild("HumanoidRootPart")
					if hr and (hr.Position - p0).Magnitude <= r then
						out[#out + 1] = v
					end
				end
			end
		end
	end

	for _, pl in next, P:GetPlayers() do
		if #out >= maxN then
			break
		end
		if pl ~= L and pl.Character and okm(pl.Character) then
			local hr = pl.Character:FindFirstChild("HumanoidRootPart")
			if hr and (hr.Position - p0).Magnitude <= r then
				out[#out + 1] = pl.Character
			end
		end
	end

	return out
end

pkg = function(t)
	local main, hits = nil, {}
	for _, v in next, t do
		if okm(v) then
			local p = hpt(v)
			if p then
				if not main then
					main = p
				end
				hits[#hits + 1] = {
					v,
					p
				}
			end
		end
	end
	return main, hits
end

send = function(main, hits)
	if main and #hits > 0 then
		if IS then
			IS(main, hits)
		elseif RH then
			RH:FireServer(main, hits)
		end
	end
end

local AC, HM = {}, nil

setH = function(c)
	local h = c:FindFirstChildWhichIsA("Humanoid")
	if h then
		HM = h;
		AC = {}
	end
end

if L.Character then
	setH(L.Character)
end
L.CharacterAdded:Connect(function(c)
	c:WaitForChild("Humanoid")
	setH(c)
end)

anim = function(tool)
	if not (HM and tool and WD) then
		return
	end
	local wn = CU:GetWeaponName(tool)
	local data = WD[wn] or WD[string.lower(wn)] or WD[CU:GetPureWeaponName(wn)]
	if not (data and data.Moveset and data.Moveset.Basic) then
		return
	end

	local mv = data.Moveset.Basic
	local a = mv[math.random(1, #mv)]
	if not (a and a.AnimationId) then
		return
	end

	if not AC[a.AnimationId] then
		local n = Instance.new("Animation")
		n.AnimationId = a.AnimationId
		AC[a.AnimationId] = HM:LoadAnimation(n)
	end

	local tr = AC[a.AnimationId]
	if tr then
		tr:Play(1, 1, 2)
	end
end

spawn(function ()
	while task.wait(0.019) do
		local ok, err = pcall(function()
			local ch = L.Character
			if not ch then
				return
			end

			local tool = ch:FindFirstChildOfClass("Tool")
			if not tool then
				return
			end

			local tg = near(60, 20)
			if #tg == 0 then
				return
			end

			local main, hits = pkg(tg)
			if not main then
				return
			end

			if RA then
				RA:FireServer(0)
			end
			anim(tool)

			task.defer(function()
				pcall(function()
					CU:AttackStart(main, 1)
					CU:RunHitDetection(main.Parent or main, 1, {
						_Object = {
							Length = 0.02,
							IsPlaying = true
						}
					})
				end)
			end)

			send(main, hits)
		end)
	end
end)
