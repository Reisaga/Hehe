local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local CameraShakerR = require(ReplicatedStorage.Util.CameraShaker)
local ShootGunEvent = ReplicatedStorage.Modules.Net["RE/ShootGunEvent"]

local FastAttack = {
	Distance = 50,
	attackMobs = true,
	attackPlayers = true,
	Equipped = nil,
	Debounce = 0,
	ComboDebounce = 0,
	ShootDebounce = 0,
	M1Combo = 0,
	Overheat = {["Dragonstorm"] = {MaxOverheat = 3,Cooldown = 0,TotalOverheat = 0,Distance = 350,Shooting = false}},
	ShootsPerTarget = {["Dual Flintlock"] = 2},
	SpecialShoots = {["Skull Guitar"] = "TAP",["Bazooka"] = "Position",["Cannon"] = "Position",["Dragonstorm"] = "Overheat"},
	HitboxLimbs = {"RightLowerArm","RightUpperArm","LeftLowerArm","LeftUpperArm","RightHand","LeftHand"}
}

local cl = {"PirateBasic","PirateBrigade","FishBoat"}
local Characters = Workspace:WaitForChild("Characters")
local Enemies = Workspace:WaitForChild("Enemies")
local SeaBeasts = Workspace:WaitForChild("SeaBeasts")
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RE_ShootGunEvent = Net:WaitForChild("RE/ShootGunEvent")

local function IsAlive(c)
	return c and c:FindFirstChild("Humanoid") and c.Humanoid.Health > 0 and c:FindFirstChild("HumanoidRootPart") and not c:FindFirstChild("VehicleSeat")
end

function FastAttack:GetAllBladeHits(character, distance)
    local pos = character:GetPivot().Position
    local hits = {}
    distance = distance or self.Distance

    local function process(folder, enabled)
        if not enabled then return end
        for _, enemy in ipairs(folder:GetChildren()) do
            local part = enemy.PrimaryPart
            if part and (pos - part.Position).Magnitude <= distance then
                table.insert(hits, {enemy, part})
            end
        end
    end

    process(workspace.Enemies, self.attackMobs)
    process(workspace.Characters, self.attackPlayers)
    return hits
end

function FastAttack:GetClosestEnemy(character, distance)
    local hits = self:GetAllBladeHits(character, distance)
    local best, bestDist
    for _, h in ipairs(hits) do
        local d = (character:GetPivot().Position - h[2].Position).Magnitude
        if not bestDist or d < bestDist then
            best, bestDist = h[2], d
        end
    end
    return best
end

function FastAttack:GetGunHits(character, distance)
    local hits = self:GetAllBladeHits(character, distance)
    local group = {}
    for _, h in ipairs(hits) do
        if not group[1] or (h[2].Position - group[1].Position).Magnitude <= 10 then
            table.insert(group, h[2])
        end
    end
    return group
end

function FastAttack:GetCombo()
    local combo = (tick() - self.ComboDebounce <= 0.4) and self.M1Combo or 0
    combo = (combo >= 4) and 1 or (combo + 1)
    self.ComboDebounce = tick()
    self.M1Combo = combo
    return combo
end

function FastAttack:UseGunShoot(Character, Equipped)
    if not (Equipped and Equipped.Enabled) then return end

    local shootType = self.SpecialShoots[Equipped.Name] or "Normal"

    local function incrementShots()
        Equipped:SetAttribute("LocalTotalShots", (Equipped:GetAttribute("LocalTotalShots") or 0) + 1)
        GunValidator:FireServer(self:GetValidator2())
    end

    if shootType == "Overheat" then
        local data = self.Overheat[Equipped.Name]
        if not data or data.Shooting then return end

        local target = self:GetClosestEnemy(Character, data.Distance or 100)
        if not target then return end

        data.Shooting = true
        while Equipped and Equipped.Parent == Player.Character and data.TotalOverheat < data.MaxOverheat do
            if target and target.Parent and IsAlive(target.Parent) then
                incrementShots()
                RE_ShootGunEvent:FireServer(target.Position, { target })
                data.TotalOverheat += task.wait(data.Cooldown)
            else
                break
            end
        end
        while data.TotalOverheat > 0 do
            data.TotalOverheat = math.clamp(data.TotalOverheat - task.wait(), 0, data.MaxOverheat)
        end
        data.Shooting = false

    elseif shootType == "Normal" then
        local hits = self:GetGunHits(Character, 120)
        local targetPos = hits[1] and hits[1].Position
        if not targetPos then return end

        incrementShots()
        for i = 1, (self.ShootsPerTarget[Equipped.Name] or 1) do
            RE_ShootGunEvent:FireServer(targetPos, hits)
        end

    elseif shootType == "Position" or (shootType == "TAP" and Equipped:FindFirstChild("RemoteEvent")) then
        local target = self:GetClosestEnemy(Character, 200)
        if not target then return end

        if self.ShootsFunctions[Equipped.Name] then
            return self.ShootsFunctions[Equipped.Name](self, Equipped, target.Position)
        end

        incrementShots()
        if shootType == "TAP" then
            Equipped.RemoteEvent:FireServer("TAP", target.Position)
        else
            RE_ShootGunEvent:FireServer(target.Position)
        end
    end
end

function FastAttack:GetValidator2()
    local v1 = getupvalue(self.ShootFunction, 15)
    local v2 = getupvalue(self.ShootFunction, 13)
    local v3 = getupvalue(self.ShootFunction, 16)
    local v4 = getupvalue(self.ShootFunction, 17)
    local v5 = getupvalue(self.ShootFunction, 14)
    local v6 = getupvalue(self.ShootFunction, 12)
    local v7 = getupvalue(self.ShootFunction, 18)
        
    local v8 = v6 * v2
    local v9 = (v5 * v2 + v6 * v1) % v3
    v9 = (v9 * v3 + v8) % v4
    v5 = math.floor(v9 / v3)
    v6 = v9 - v5 * v3
    v7 = v7 + 1    
    setupvalue(self.ShootFunction, 15, v1)
    setupvalue(self.ShootFunction, 13, v2)
    setupvalue(self.ShootFunction, 16, v3)
    setupvalue(self.ShootFunction, 17, v4)
    setupvalue(self.ShootFunction, 14, v5)
    setupvalue(self.ShootFunction, 12, v6)
    setupvalue(self.ShootFunction, 18, v7)
        
    return math.floor(v9 / v4 * 16777215), v7
end	

local function getHead()
	local r = {}
	for _,v in next, Enemies:GetChildren() do
		if table.find(cl,v.Name) and v:FindFirstChild("Body") then
			for _,v1 in next,v.Body:GetChildren() do
				if (v1.Position-LocalPlayer.Character.HumanoidRootPart.Position).Magnitude<500 then
					r[#r+1]=v1
					return r
				end
			end
		elseif v:FindFirstChild("Humanoid") and v.Humanoid.Health>0 then
			if (v.Head.Position-LocalPlayer.Character.HumanoidRootPart.Position).Magnitude<100 then
				r[#r+1]=v.HumanoidRootPart
			end
		end
	end
	if #r==0 then
		for _,v in next, SeaBeasts:GetChildren() do
			if v:FindFirstChild("RootPart") then
				if (v.RootPart.Position-LocalPlayer.Character.HumanoidRootPart.Position).Magnitude<500 then
					r[#r+1]=v.RootPart
				end
			end
		end
	end
	return r
end

local function FastShooted()
	local h=getHead()
	for i=1,#h do
		if #h>0 then
			local self=FastAttack
			local Character=LocalPlayer.Character
			if not IsAlive(Character) then return end
			local Humanoid=Character.Humanoid
			local Equipped=Character:FindFirstChildOfClass("Tool")
			local ToolTip=Equipped and Equipped.ToolTip
			if Equipped and (ToolTip=="Gun" or ToolTip=="Melee" or ToolTip=="Blox Fruit" or ToolTip=="Sword") then
				local Cooldown=Equipped:FindFirstChild("Cooldown") and Equipped.Cooldown.Value or 0.3
				if (tick()-self.Debounce)>=Cooldown and self:CheckStun(ToolTip,Character,Humanoid) then
					local Combo=self:GetCombo()
					Cooldown+=Combo>=4 and 0.05 or 0
					self.Equipped=Equipped
					self.Debounce=Combo>=4 and ToolTip~="Gun" and (tick()+0.05) or tick()
					if ToolTip=="Gun" then
						self:UseGunShoot(Character,Equipped)
						ShootGunEvent:FireServer(h[i].Position,{[1]=h[i]})
						ShootGunEvent:FireServer(h[i].Position,{[1]=h[i]})
						sethiddenproperty(LocalPlayer,"SimulationRadius",math.huge)
					end
				end
			end
		end
	end
end

for i=1,20 do
	task.spawn(function()
		while task.wait() do
			local ok,err=xpcall(FastShooted,function()end)
			if not ok then break end
			CameraShakerR:Stop()
			if not FastShot then break end
		end
	end)
end
